<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pSunDAI ‚Äì Golden Sun Vault</title>
  <link rel="icon" href="sundailogo.png" type="image/png" />
  <meta name="description" content="Autonomous 150% PLS-Collateralized Stable Asset on PulseChain." />
  <meta name="theme-color" content="#FF6B00" />
  <meta name="robots" content="index,follow" />
  <meta name="author" content="SunDAI Protocol" />
  <script src="ethers.umd.min.js"></script>

  <style>
    body {
      margin: 0;
      background: #0a001f;
      color: #ffebd1;
      font-family: Segoe UI, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      overflow-y: auto;
    }
    canvas {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
    }
    .wallet {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #111;
      padding: 10px 22px;
      border: 2px solid #ff6b00;
      border-radius: 10px;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      z-index: 9999;
      transition: all 0.2s ease;
      pointer-events: auto;
    }
    .wallet:hover { background: #222; }
    .wallet.connected {
      border-color: #ffd700;
      color: #ffd700;
    }

    .container {
      background: rgba(10, 0, 30, 0.8);
      backdrop-filter: blur(20px);
      border: 2px solid #ff6b00;
      border-radius: 20px;
      box-shadow: 0 0 40px rgba(255, 215, 0, 0.25);
      padding: 30px 25px;
      max-width: 480px;
      width: 90%;
      margin: 80px 0;
      position: relative;
      z-index: 10;
    }

.logo {
  display: block;
  max-width: 240px;
  margin: 0 auto 10px;
  animation: pulseGlow 4s ease-in-out infinite;
  transform-origin: center;
}

@keyframes pulseGlow {
  0% { filter: drop-shadow(0 0 10px rgba(180, 120, 255, 0.5)); }
  50% { filter: drop-shadow(0 0 35px rgba(255, 180, 255, 0.85)); }
  100% { filter: drop-shadow(0 0 10px rgba(180, 120, 255, 0.5)); }
}

    h1 {
      text-align: center;
      font-size: 2em;
      background: linear-gradient(90deg, #ff6b00, #ffd700, #ffa500);
      -webkit-background-clip: text;
      color: transparent;
      margin-bottom: 8px;
    }
    h2 {
      text-align: center;
      color: #ffebd1;
      font-size: 1.1em;
      margin-top: 0;
    }

    .price {
      text-align: center;
      color: #ffd700;
      font-weight: 800;
      font-size: 1.2em;
      margin-bottom: 10px;
    }

    .card {
      background: rgba(255, 107, 0, 0.1);
      border: 1px solid rgba(255, 107, 0, 0.3);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 12px;
      transition: box-shadow .2s ease;
    }
    .card:hover { box-shadow: 0 0 12px rgba(255,215,0,0.15); }

    input,
    .btn {
      width: 100%;
      display: block;
      box-sizing: border-box;
      font-size: 1em;
      font-weight: 700;
      text-align: center;
      border-radius: 10px;
      padding: 14px;
      transition: all 0.2s ease;
    }

    input {
      background: #110022;
      border: 2px solid rgba(255, 107, 0, 0.4);
      color: #fff;
    }
    input:focus {
      border-color: #ffd700;
      outline: none;
    }

    .btn {
      background: #ff6b00;
      border: 2px solid transparent;
      color: #000;
      cursor: pointer;
    }
    .btn:hover { background: #ffd700; transform: translateY(-2px); }
    .btn:disabled {
      background: #444;
      color: #999;
      cursor: not-allowed;
      border-color: transparent;
    }

    .card input + .btn { margin-top: 8px; }

    .preview {
      color: #ffbd70;
      text-align: center;
      font-size: 0.9em;
      margin-top: 4px;
    }

    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      text-align: center;
      font-size: 0.9em;
    }
    .stat {
      background: rgba(255, 107, 0, 0.12);
      padding: 10px;
      border-radius: 10px;
    }
    .label { color: #ffbd70; }
    .value { color: #ffd700; font-weight: 700; }

    .status, .error {
      text-align: center;
      font-weight: bold;
      margin-top: 10px;
      transition: opacity .4s ease;
    }
    .status { color: #00ff9d; }
    .error { color: #ff3366; }

    .value.safe { color: #00ff9d; text-shadow: 0 0 8px rgba(0,255,157,0.5); }
    .value.warn { color: #ffcc00; text-shadow: 0 0 8px rgba(255,204,0,0.5); }
    .value.risk { color: #ff3366; text-shadow: 0 0 8px rgba(255,51,102,0.5); }

    .footer {
      text-align: center;
      margin: 40px 0 20px;
      padding: 20px 10px;
      font-size: 0.85em;
      color: #ffbd70;
      border-top: 1px solid rgba(255, 215, 0, 0.15);
      width: 100%;
      max-width: 800px;
      z-index: 5;
      position: relative;
    }
    .footer h3 {
      margin-bottom: 10px;
      color: #ffd700;
      letter-spacing: 0.5px;
      font-size: 1.1em;
    }
    .contracts {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
      text-align: left;
      line-height: 1.6;
      word-wrap: break-word;
      overflow-wrap: anywhere;
      padding: 0 10px;
      max-width: 100%;
      box-sizing: border-box;
    }
    .contracts a {
      color: #ffebd1;
      text-decoration: none;
      font-family: monospace;
      word-break: break-all;
      display: inline-block;
      max-width: 100%;
      overflow-wrap: anywhere;
      transition: color 0.2s ease;
    }
    .contracts a:hover { color: #ffd700; }
    .contracts .label {
      color: #ff6b00;
      font-weight: 700;
      display: block;
      margin-bottom: 2px;
    }

    @media (max-width: 480px) {
      .contracts { font-size: 0.75em; gap: 8px; }
      .contracts a { font-size: 0.75em; }
    }
    #bg {
  opacity: 0;
  animation: fadeIn 2s ease forwards;
}

@keyframes fadeIn {
  to { opacity: 1; }
}

  </style>
</head>

<body>
  <div id="bg"></div>
  <div class="wallet" id="walletBtn"><span id="walletText">Connect Wallet</span></div>

  <div class="container">
    <img src="sundailogo.png" class="logo" alt="SunDAI Logo" />
    <h1>SunDAI</h1>
    <h2>Autonomous Stable Asset</h2>
    <div class="price" id="price">Loading price...</div>
    <div class="status" id="status"></div>
    <div class="error" id="error"></div>

    <div class="card"><div class="stats" id="stats">Connect wallet</div></div>

    <div class="card">
      <input id="usdOneClick" type="number" step="0.01" placeholder="Deposit & Auto Mint (USD)" />
      <div class="preview" id="plsOneClick"></div>
      <button class="btn" id="oneClickBtn" disabled>1-Click Auto Mint (155%)</button>
    </div>

    <div class="card">
      <input id="usdIn" type="number" step="0.01" placeholder="Deposit USD" />
      <div class="preview" id="plsOut"></div>
      <button class="btn" id="deposit" disabled>Deposit PLS</button>
    </div>

    <div class="card">
      <input id="usdMint" type="number" step="0.01" placeholder="Mint USD" />
      <button class="btn" id="mint" disabled>Mint pSunDAI</button>
    </div>

    <div class="card">
      <input id="usdRepay" type="number" step="0.01" placeholder="Repay USD" />
      <button class="btn" id="repay" disabled>Repay</button>
    </div>

    <div class="card">
      <input id="usdOut" type="number" step="0.01" placeholder="Withdraw USD" />
      <div class="preview" id="plsIn"></div>
      <button class="btn" id="withdraw" disabled>Withdraw PLS</button>
    </div>

       <div class="card">
      <button class="btn" id="risk" disabled style="background:#ff3366">Check Risk</button>
      <div id="riskText" style="margin-top:10px;text-align:center;font-weight:700"></div>
    </div>

    <!-- üü¢ Safety / Oracle Sync Status -->
    <div class="card" id="safetyCard" style="margin-top: 12px;">
      <div id="safetyStatus" style="text-align:center;font-weight:700;color:#ffd700;margin-bottom:8px;">
        Checking Oracle status...
      </div>
      <button class="btn" id="pokeBtn" disabled style="background:#ffaa00;border-color:#ffcc00;">
        Wake Oracle üåû
      </button>
    </div>

  </div> <!-- ‚úÖ now this closes the container at the right time -->


  <script>
    // Detect ethers global across versions
    const ethers =
      (window.ethers && window.ethers.Contract) ? window.ethers :
      window.ethers?.ethers ?? null;
    if (!ethers) alert("‚ö†Ô∏è Ethers not loaded correctly. Check ethers.umd.min.js version.");

    const VAULT  = "0x253506fA54c1B2cC837E9E5b1eB0Cde9acF9bD3c";
    const TOKEN  = "0xf822bE76E69f0Ff90D9102eD9b97C5A78EEcf8f9";
    const ORACLE = "0x259A012eE1b60338EDBdF0aC75ae20F55F1c302B";

    window.provider = null;
window.signer = null;
window.vault = null;
window.token = null;
window.oracle = null;
window.account = null;
window.price = 0n;


    async function loadABIs(){
      const v = await fetch("vault-abi.json").then(r=>r.json());
      const t = await fetch("token-abi.json").then(r=>r.json());
      const o = await fetch("oracle-abi.json").then(r=>r.json());
      return [v,t,o];
    }

    async function connectWallet(){
      try {
        if(!window.ethereum){ alert("No wallet detected. Please install MetaMask."); return; }
        await window.ethereum.request({method:"eth_requestAccounts"});
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        account = await signer.getAddress();

        const network = await provider.getNetwork();
        status.textContent = `Connected to ${network.name}`;
        walletText.textContent = account.slice(0,6)+"..."+account.slice(-4);
        walletBtn.classList.add("connected");
        document.querySelectorAll(".btn").forEach(b=>b.disabled=false);

        const [VAULT_ABI,TOKEN_ABI,ORACLE_ABI] = await loadABIs();
        vault  = new ethers.Contract(VAULT, VAULT_ABI, signer);
        token  = new ethers.Contract(TOKEN, TOKEN_ABI, signer);
        oracle = new ethers.Contract(ORACLE, ORACLE_ABI, provider);

        await updatePrice();
        await loadVault();
        setInterval(updatePrice, 60000);
      } catch(e){ console.error(e); error.textContent = e.message; }
    }

    async function updatePrice(){
      try {
        const [p] = await oracle.peekPriceView();
        price = p;
        document.getElementById("price").textContent = "$" + (Number(p)/1e18).toFixed(6) + " per PLS";
      } catch {
        document.getElementById("price").textContent = "Oracle offline";
      }
    }

    function usdToPLS(usd){ if(!price)return 0n; const usdWei=ethers.parseEther(usd.toString()); return (usdWei*(10n**18n))/price; }
    function usdToPSun(usd){ return ethers.parseEther(usd.toString()); }

    ["usdIn","usdOut"].forEach(id=>{
      document.getElementById(id).addEventListener("input",()=>{
        const usd=parseFloat(document.getElementById(id).value)||0;
        const pls=usdToPLS(usd);
        const text=usd>0?`‚âà ${Math.round(Number(ethers.formatEther(pls)))} PLS`:"";
        document.getElementById(id==="usdIn"?"plsOut":"plsIn").textContent=text;
      });
    });

   async function loadVault(){
  try {
    const i = await vault.vaultInfo(account);
    const ratioValue = Number(i.ratio); // already in percent
    let ratioClass = ratioValue < 150 ? "risk" : ratioValue < 170 ? "warn" : "safe";
    const ratioDisplay = ratioValue > 1e6 ? "‚àû" : ratioValue.toFixed(2) + "%";

    stats.innerHTML = `
      <div class="stat">
        <div class="label">Collateral</div>
        <div class="value">${Math.round(Number(ethers.formatEther(i.collateral)))} PLS</div>
      </div>
      <div class="stat">
        <div class="label">Debt</div>
        <div class="value">${Number(ethers.formatEther(i.debt)).toFixed(2)} pSunDAI</div>
      </div>
      <div class="stat">
        <div class="label">Ratio</div>
        <div class="value ${ratioClass}">${ratioDisplay}</div>
      </div>
      <div class="stat">
        <div class="label">Can Mint</div>
        <div class="value">${Number(ethers.formatEther(i.mintable)).toFixed(2)} pSunDAI</div>
      </div>
    `;
  } catch (e) {
    error.textContent = e.message;
  }
}

    walletBtn.onclick = connectWallet;

    deposit.onclick = async()=>{
      const u=parseFloat(usdIn.value); if(!u)return alert("Enter amount");
      await (await vault.depositPLS({value:usdToPLS(u)})).wait(); loadVault();
    };
    mint.onclick = async()=>{
      const u=parseFloat(usdMint.value); if(!u)return alert("Enter amount");
      await (await vault.mint(usdToPSun(u))).wait(); loadVault();
    };
    repay.onclick = async()=>{
      const u=parseFloat(usdRepay.value); if(!u)return alert("Enter amount");
      await (await token.approve(VAULT,usdToPSun(u))).wait();
      await (await vault.repay(usdToPSun(u))).wait(); loadVault();
    };
    withdraw.onclick = async()=>{
      const u=parseFloat(usdOut.value); if(!u)return alert("Enter amount");
      await (await vault.withdrawPLS(usdToPLS(u))).wait(); loadVault();
    };
    risk.onclick = async()=>{
      const c=await vault.canLiquidate(account);
      riskText.innerHTML=c?'<span class="risk">‚ö†Ô∏è LIQUIDATION RISK ‚ö†Ô∏è</span>':'<span class="safe">You are safe üåû</span>';
    };

    usdOneClick.addEventListener("input",()=>{
      const usd=parseFloat(usdOneClick.value)||0;
      if(!usd||!price){plsOneClick.textContent="";return;}
      const pls=usdToPLS(usd);
      const mintUSD=usd/1.55;
      plsOneClick.textContent=`‚âà ${Math.round(Number(ethers.formatEther(pls)))} PLS ‚Üí ${mintUSD.toFixed(2)} pSunDAI (at 155%)`;
    });

            oneClickBtn.onclick = async()=>{
      const usd=parseFloat(usdOneClick.value);
      if(!usd)return alert("Enter amount");
      try{
        oneClickBtn.textContent="Processing...";
        const plsValue=usdToPLS(usd);
        const tx=await vault.depositAndAutoMintPLS({value:plsValue});
        await tx.wait();
        status.textContent=`Deposited ${usd.toFixed(2)} USD and auto-minted ${(usd/1.55).toFixed(2)} pSunDAI`;
        loadVault();
      }catch(e){ error.textContent=e.message; }
      finally{ oneClickBtn.textContent="1-Click Auto Mint (155%)"; }
    };
     </script>

<footer class="footer">
  <h3>Official Contracts</h3>
  <div class="contracts">
    <div>
      <span class="label">pSunDAI Token:</span>
      <a href="https://scan.pulsechain.com/address/0xf822bE76E69f0Ff90D9102eD9b97C5A78EEcf8f9" target="_blank">
        0xf822bE76E69f0Ff90D9102eD9b97C5A78EEcf8f9
      </a>
    </div>
    <div>
      <span class="label">Vault:</span>
      <a href="https://scan.pulsechain.com/address/0x253506fA54c1B2cC837E9E5b1eB0Cde9acF9bD3c" target="_blank">
        0x253506fA54c1B2cC837E9E5b1eB0Cde9acF9bD3c
      </a>
    </div>
    <div>
      <span class="label">Oracle:</span>
      <a href="https://scan.pulsechain.com/address/0x259A012eE1b60338EDBdF0aC75ae20F55F1c302B" target="_blank">
        0x259A012eE1b60338EDBdF0aC75ae20F55F1c302B
      </a>
    </div>
  </div>
</footer>

<!-- üåû Safety Logic (Guaranteed Instant Status ‚Äî ABI-Corrected) -->
<script>
window.addEventListener("load", () => {
  console.log("üåû Safety logic loaded");

  // ‚è≥ Wait for oracle to be defined
  async function waitForOracle(timeoutMs = 10000) {
    const start = Date.now();
    while ((!window.oracle || !window.oracle.isHealthy) && Date.now() - start < timeoutMs) {
      console.log("‚è≥ Waiting for oracle to initialize...");
      await new Promise(r => setTimeout(r, 300));
    }
    if (!window.oracle) throw new Error("Oracle not initialized within timeout");
    return window.oracle;
  }

  // üö® Safe RPC calls with timeout
  async function safeCall(promise, timeoutMs = 4000) {
    return Promise.race([
      promise,
      new Promise((_, reject) =>
        setTimeout(() => reject(new Error("RPC timeout")), timeoutMs)
      )
    ]);
  }

  // üß† Check Oracle health and freshness
  async function checkOracleHealth() {
    const statusEl = document.getElementById("safetyStatus");
    const pokeBtn = document.getElementById("pokeBtn");

    try {
      const oracle = await waitForOracle();
      statusEl.textContent = "üîÑ Checking Oracle...";
      statusEl.style.color = "#ffd700";
      pokeBtn.disabled = true;

      let price, timestamp;
      try {
        // ‚úÖ Preferred: use getPriceWithTimestamp() (nonpayable)
        [price, timestamp] = await oracle.callStatic.getPriceWithTimestamp();
        console.log("üì° Got price from getPriceWithTimestamp()");
      } catch (err) {
        console.warn("‚ö†Ô∏è Fallback to peekPriceView() due to:", err.message);
        [price, timestamp] = await safeCall(oracle.peekPriceView(), 3000);
      }

      const healthy = await safeCall(oracle.isHealthy(), 3000);
      const age = Math.floor(Date.now() / 1000 - Number(timestamp));

      if (healthy && age < 86400) {
        statusEl.innerHTML = `üü¢ Vault & Oracle synced ‚Äì data fresh (${(age / 60).toFixed(1)} min ago)`;
        statusEl.style.color = "#00ff9d";
        pokeBtn.disabled = true;
      } else {
        statusEl.innerHTML = "üî¥ Oracle stale ‚Äì press <b>Wake Oracle üåû</b> to refresh";
        statusEl.style.color = "#ff3366";
        pokeBtn.disabled = false;
      }

      console.log("‚úÖ Oracle check complete", {
        healthy,
        age,
        price: String(price),
        timestamp: Number(timestamp)
      });

    } catch (e) {
      console.warn("‚ö†Ô∏è Oracle check failed:", e);
      const statusEl = document.getElementById("safetyStatus");
      statusEl.textContent = "‚ö†Ô∏è " + e.message;
      statusEl.style.color = "#ff3366";
      document.getElementById("pokeBtn").disabled = false;
    }
  }

  // üîó Run check when wallet connects
  const originalConnectWallet = window.connectWallet;
  window.connectWallet = async function () {
    await originalConnectWallet();
    console.log("üîó Wallet connected, starting oracle check");

    const statusEl = document.getElementById("safetyStatus");
    const safetyCard = document.getElementById("safetyCard");
    safetyCard.style.opacity = "1";
    statusEl.textContent = "üîÑ Checking Oracle...";
    statusEl.style.color = "#ffd700";

    // run instantly after wallet connect
    await checkOracleHealth();

    // recheck every 20s
    setInterval(checkOracleHealth, 20000);
  };

  // üåû Manual wake-up button
  document.getElementById("pokeBtn").onclick = async () => {
    const statusEl = document.getElementById("safetyStatus");
    try {
      const oracle = await waitForOracle();
      if (!window.signer) {
        alert("Please connect your wallet first!");
        return;
      }

      statusEl.textContent = "‚è≥ Sending wake-up...";
      statusEl.style.color = "#ffd700";

      const tx = await oracle.connect(window.signer).poke();
      await tx.wait();

      statusEl.textContent = "‚úÖ Oracle awakened & synced!";
      statusEl.style.color = "#00ff9d";
      setTimeout(checkOracleHealth, 2500);
    } catch (e) {
      statusEl.textContent = "‚ö†Ô∏è " + e.message;
      statusEl.style.color = "#ff3366";
    }
  };
});
</script>

<!-- üåå Golden Nebula Drift Background -->
<style>
  #bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 0;
    pointer-events: none;
    background: radial-gradient(circle at 25% 25%, rgba(255,190,80,0.15), transparent 60%),
                radial-gradient(circle at 75% 70%, rgba(255,130,40,0.12), transparent 60%),
                radial-gradient(circle at 50% 50%, rgba(110,0,150,0.18), transparent 70%);
    background-repeat: no-repeat;
    background-size: cover;
    transition: background 1s ease; /* faster background transitions */
    opacity: 0;
    animation: fadeIn 2s ease forwards, nebulaPulse 10s ease-in-out infinite;
  }

  @keyframes fadeIn {
    to { opacity: 1; }
  }

  @keyframes nebulaPulse {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(1.25); }
  }

  /* ‚ú® Glow intensifies slightly when hovering vault container */
  .container:hover ~ #bg {
    filter: brightness(1.35);
  }
</style>

<script>
  const bg = document.getElementById("bg");
  let t = 0;
  let mouseX = 0, mouseY = 0, targetX = 0, targetY = 0;

  function animateNebula() {
    t += 0.004; // üî• faster drift speed

    // Smooth interpolation for parallax motion
    mouseX += (targetX - mouseX) * 0.05;
    mouseY += (targetY - mouseY) * 0.05;

    // Dynamic, noticeable movement
    const x1 = 25 + Math.sin(t * 0.7) * 20 + mouseX * 15;
    const y1 = 25 + Math.cos(t * 0.8) * 15 + mouseY * 10;
    const x2 = 75 + Math.cos(t * 0.5) * 18 - mouseX * 12;
    const y2 = 70 + Math.sin(t * 0.6) * 14 - mouseY * 10;
    const x3 = 50 + Math.sin(t * 0.3) * 15 + mouseX * 10;
    const y3 = 50 + Math.cos(t * 0.4) * 12 + mouseY * 10;

    // Slightly stronger opacity for visual definition
    bg.style.background = `
      radial-gradient(circle at ${x1}% ${y1}%, rgba(255,200,100,0.20), transparent 65%),
      radial-gradient(circle at ${x2}% ${y2}%, rgba(255,130,40,0.16), transparent 65%),
      radial-gradient(circle at ${x3}% ${y3}%, rgba(120,0,180,0.22), transparent 75%)
    `;

    requestAnimationFrame(animateNebula);
  }

  // üéØ Mouse parallax control
  window.addEventListener("mousemove", (e) => {
    targetX = (e.clientX / window.innerWidth - 0.5);
    targetY = (e.clientY / window.innerHeight - 0.5);
  });

  // üì± Device tilt parallax for mobile
  window.addEventListener("deviceorientation", (e) => {
    if (e.gamma && e.beta) {
      targetX = e.gamma / 45;
      targetY = e.beta / 45;
    }
  });

  animateNebula();
</script>

</body>
</html>
