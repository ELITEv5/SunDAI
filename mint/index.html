<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>pSunDAI – Golden Sun Vault</title>
  <link rel="icon" href="https://i.imgur.com/8v5V9wK.png" type="image/png">
  <meta property="og:image" content="https://i.imgur.com/8v5V9wK.png">
  <meta name="description" content="Autonomous 150% PLS-Collateralized Stable Asset on PulseChain. No admin. Pure golden sun energy.">
  <meta name="theme-color" content="#FF6B00">
  <script src="https://cdn.ethers.io/lib/ethers-6.13.1.umd.min.js"></script>

  <style>
    :root {
      --primary: #FF6B00;
      --accent:  #FFD700;
      --bg:      #0a001f;
      --card:    rgba(255,107,0,0.12);
      --glow:    rgba(255,215,0,0.6);
      --text:    #ffebd1;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;overflow-x:hidden}
    canvas#cosmos-bg{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0}
    .container{background:rgba(10,0,30,0.75);backdrop-filter:blur(20px);border-radius:24px;padding:40px 30px;max-width:660px;width:100%;border:2px solid var(--primary);box-shadow:0 0 100px var(--glow),inset 0 0 40px rgba(255,107,0,0.1);position:relative;z-index:10}
    h1{font-size:3.4em;background:linear-gradient(90deg,#FF6B00,#FFD700,#FFA500);-webkit-background-clip:text;color:transparent;margin-bottom:8px;text-shadow:0 0 40px var(--glow)}
    .subtitle{color:var(--accent);font-size:1.4em;margin-bottom:30px;text-align:center}
    .wallet-button{position:fixed;top:20px;right:20px;background:rgba(10,0,30,0.9);backdrop-filter:blur(12px);padding:12px 28px;border:2px solid var(--primary);border-radius:12px;color:#fff;font-weight:700;cursor:pointer;transition:all .3s;z-index:9999}
    .wallet-button:hover{border-color:var(--accent);box-shadow:0 0 40px var(--glow)}
    .wallet-button.connected{color:var(--accent);border-color:var(--accent)}
    .price{display:flex;align-items:center;justify-content:center;font-size:2.2em;font-weight:900;color:var(--accent);margin:20px 0}
    .card{background:var(--card);border:1px solid rgba(255,107,0,0.3);border-radius:16px;padding:20px;margin:15px 0;box-shadow:0 8px 32px rgba(255,107,0,0.15)}
    .input-group{margin:20px 0}
    input{width:100%;padding:16px;border-radius:12px;border:2px solid rgba(255,107,0,0.4);background:#110022;color:#fff;font-size:18px;text-align:center}
    input:focus{border-color:var(--accent);outline:none;box-shadow:0 0 20px var(--glow)}
    .btn{width:100%;padding:18px;background:var(--primary);color:#000;border:none;border-radius:14px;font-size:18px;font-weight:900;cursor:pointer;margin-top:15px;transition:all .3s;box-shadow:0 0 30px var(--glow)}
    .btn:hover{background:var(--accent);color:#000;transform:translateY(-3px)}
    .btn:disabled{background:#333;color:#666;cursor:not-allowed}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:20px;font-size:14px}
    .stat{background:rgba(255,107,0,0.1);padding:12px;border-radius:10px;text-align:center}
    .stat-label{color:#ffbd70}
    .stat-value{font-weight:900;color:var(--accent);font-size:1.2em}
    .risk{color:#ff3366}
    .safe{color:#00ff9d}
    .logo{max-width:320px;width:100%;margin:0 auto 20px;display:block;filter:drop-shadow(0 0 30px var(--glow))}
    #plsPreview,#plsWithdrawPreview{color:#ffbd70;font-size:14px;margin:8px 0}
    @media(max-width:768px){
      h1{font-size:2.4em}
      .container{padding:30px 20px}
      .stats-grid{grid-template-columns:1fr}
      .price{font-size:1.8em}
    }
  </style>
</head>
<body>
  <canvas id="cosmos-bg"></canvas>

  <div id="walletButton" class="wallet-button" onclick="connectWallet()">
    <span id="walletText">Connect Wallet</span>
  </div>

  <div class="container">
    <img src="https://i.imgur.com/8v5V9wK.png" alt="pSunDAI Golden Sun" class="logo">
    <h1>pSunDAI Vault</h1>
    <p class="subtitle">Autonomous • Immutable • 150% PLS Collateral</p>

    <div class="price" id="priceDisplay">Loading oracle...</div>

    <div class="card">
      <div class="stats-grid" id="vaultStats"></div>
    </div>

    <div class="card">
      <div class="input-group">
        <input id="usdDeposit" type="number" step="0.01" placeholder="Deposit amount in USD">
        <div id="plsPreview"></div>
        <button class="btn" id="depositBtn">Deposit PLS</button>
      </div>
    </div>

    <div class="card">
      <div class="input-group">
        <input id="usdMint" type="number" step="0.01" placeholder="Mint pSunDAI in USD">
        <button class="btn" id="mintBtn">Mint pSunDAI</button>
      </div>
    </div>

    <div class="card">
      <div class="input-group">
        <input id="usdRepay" type="number" step="0.01" placeholder="Repay pSunDAI in USD">
        <button class="btn" id="repayBtn">Repay Debt</button>
      </div>
    </div>

    <div class="card">
      <div class="input-group">
        <input id="usdWithdraw" type="number" step="0.01" placeholder="Withdraw PLS in USD">
        <div id="plsWithdrawPreview"></div>
        <button class="btn" id="withdrawBtn">Withdraw PLS</button>
      </div>
    </div>

    <div class="card">
      <button class="btn" id="riskBtn" style="background:#ff3366">Check Liquidation Risk</button>
      <div id="riskDisplay" style="margin-top:15px;text-align:center;font-weight:700;font-size:1.2em"></div>
    </div>

    <div class="card" style="text-align:center;font-size:14px;margin-top:30px">
      <p>System Health: <span id="systemHealth">Loading...</span></p>
      <p>Total Debt: <span id="totalDebt">–</span> pSunDAI</p>
      <p>Stability Fee: 0.5% annual • No admin • Golden Sun Energy</p>
    </div>
  </div>

  <script>
    const { ethers } = window.ethers;

    const TOKEN = '0x98316280B93F835Ef561C59430270D31e0575A44';
    const VAULT = '0xBFd8C212e0A132b2e58d45e0b5ccA3D2009d3778';
    const ORACLE = '0xD3c339d4e0b48E77a781dA61724672625b5CD56d';

    const VAULT_ABI = [ /* Paste your full sundaivaultabi.json array here */ ];
    const TOKEN_ABI = [ /* Paste your full sundaitokenabi.json array here */ ];
    const ORACLE_ABI = [{"inputs":[],"name":"peekPriceView","outputs":[{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"}];

    let provider, signer, vault, token, oracle, account, price = 0n;

    // COSMIC NEBULA BACKGROUND
    const canvas = document.getElementById('cosmos-bg');
    const ctx = canvas.getContext('2d');
    let w, h, time = 0;
    function resize() { w = canvas.width = innerWidth; h = canvas.height = innerHeight; }
    resize(); window.addEventListener('resize', resize);

    const layers = [
      { speed: 0.3, scale: 1.4, opacity: 0.4, hue: 35 },
      { speed: 0.5, scale: 1.0, opacity: 0.6, hue: 45 },
      { speed: 0.8, scale: 0.7, opacity: 0.5, hue: 55 },
    ];

    function drawNebula() {
      ctx.clearRect(0, 0, w, h);
      time += 0.003;

      layers.forEach(l => {
        const t = time * l.speed;
        const grad = ctx.createLinearGradient(0, 0, w, h);
        grad.addColorStop(0, `hsla(${l.hue + Math.sin(t)*10}, 90%, 60%, 0)`);
        grad.addColorStop(0.3, `hsla(${l.hue + 15}, 95%, 70%, ${l.opacity})`);
        grad.addColorStop(0.5, `hsla(${l.hue + 30}, 100%, 80%, ${l.opacity + 0.2})`);
        grad.addColorStop(0.7, `hsla(${l.hue + 15}, 95%, 70%, ${l.opacity})`);
        grad.addColorStop(1, `hsla(${l.hue}, 90%, 60%, 0)`);
        ctx.globalCompositeOperation = 'screen';
        ctx.filter = `blur(${20 * l.scale}px)`;
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, w, h);
      });

      const pulse = 0.5 + 0.5 * Math.sin(time * 2);
      const sunX = w * 0.5 + Math.cos(time * 0.7) * w * 0.1;
      const sunY = h * 0.5 + Math.sin(time * 0.5) * h * 0.1;
      const sunGrad = ctx.createRadialGradient(sunX, sunY, 0, sunX, sunY, 400 * pulse);
      sunGrad.addColorStop(0, `rgba(255, 220, 100, ${0.8 * pulse})`);
      sunGrad.addColorStop(0.4, `rgba(255, 160, 0, ${0.4 * pulse})`);
      sunGrad.addColorStop(1, 'rgba(255, 100, 0, 0)');
      ctx.filter = 'blur(80px)';
      ctx.fillStyle = sunGrad;
      ctx.fillRect(0, 0, w, h);

      ctx.filter = 'none';
      ctx.globalCompositeOperation = 'source-over';
      requestAnimationFrame(drawNebula);
    }
    drawNebula();

    async function connectWallet() {
      if (!window.ethereum) return alert('Install MetaMask!');
      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        account = await signer.getAddress();

        vault = new ethers.Contract(VAULT, VAULT_ABI, signer);
        token = new ethers.Contract(TOKEN, TOKEN_ABI, signer);
        oracle = new ethers.Contract(ORACLE, ORACLE_ABI, provider);

        document.getElementById('walletText').textContent = account.slice(0,6)+'...'+account.slice(-4);
        document.getElementById('walletButton').classList.add('connected');

        await updatePrice();
        setInterval(updatePrice, 30000);
        await updateAll();
      } catch (e) { alert(e.message); }
    }

    async function updatePrice() {
      try {
        const [p] = await oracle.peekPriceView();
        price = p;
        const usd = Number(p) / 1e18;
        document.getElementById('priceDisplay').textContent = `$${usd.toFixed(6)} per PLS`;
      } catch { document.getElementById('priceDisplay').textContent = 'Oracle offline'; }
    }

    function usdToPLS(usd) { return price ? ethers.parseEther(usd.toString()) * 1e18 / price : 0n; }
    function usdToPSun(usd) { return ethers.parseEther(usd.toString()); }

    ['usdDeposit','usdWithdraw'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => {
        const usd = parseFloat(document.getElementById(id).value) || 0;
        const pls = usdToPLS(usd);
        const txt = usd > 0 ? `≈ ${Number(ethers.formatEther(pls)).toFixed(6)} PLS` : '';
        document.getElementById(id === 'usdDeposit' ? 'plsPreview' : 'plsWithdrawPreview').textContent = txt;
      });
    });

    async function updateAll() {
      const info = await vault.vaultInfo(account);
      const ratio = info.ratio > 1e30 ? 'Infinite' : (Number(info.ratio)/100).toFixed(2)+'%';

      document.getElementById('vaultStats').innerHTML = `
        <div class="stat"><div class="stat-label">Collateral</div><div class="stat-value">${Number(ethers.formatEther(info.collateral)).toFixed(4)} PLS</div></div>
        <div class="stat"><div class="stat-label">Debt</div><div class="stat-value">${Number(ethers.formatEther(info.debt)).toFixed(4)} pSunDAI</div></div>
        <div class="stat"><div class="stat-label">Ratio</div><div class="stat-value ${Number(info.ratio)<15000?'risk':'safe'}">${ratio}</div></div>
        <div class="stat"><div class="stat-label">Can Mint</div><div class="stat-value">${Number(ethers.formatEther(info.mintable)).toFixed(4)} pSunDAI</div></div>
      `;

      const sys = await vault.systemHealth();
      document.getElementById('systemHealth').textContent = (Number(sys)/100).toFixed(2)+'%';
      document.getElementById('totalDebt').textContent = Number(ethers.formatEther(await vault.totalDebt())).toFixed(0);
    }

    document.getElementById('depositBtn').onclick = async () => {
      const usd = parseFloat(document.getElementById('usdDeposit').value);
      if (!usd) return alert('Enter USD amount');
      const tx = await vault.depositPLS({value: usdToPLS(usd)});
      await tx.wait(); alert(`Deposited $${usd.toFixed(2)}`); updateAll();
    };
    document.getElementById('mintBtn').onclick = async () => {
      const usd = parseFloat(document.getElementById('usdMint').value);
      if (!usd) return alert('Enter USD amount');
      const tx = await vault.mint(usdToPSun(usd));
      await tx.wait(); alert(`Minted $${usd.toFixed(2)} pSunDAI`); updateAll();
    };
    document.getElementById('repayBtn').onclick = async () => {
      const usd = parseFloat(document.getElementById('usdRepay').value);
      if (!usd) return alert('Enter USD amount');
      await (await token.approve(VAULT, usdToPSun(usd))).wait();
      const tx = await vault.repay(usdToPSun(usd));
      await tx.wait(); alert(`Repaid $${usd.toFixed(2)}`); updateAll();
    };
    document.getElementById('withdrawBtn').onclick = async () => {
      const usd = parseFloat(document.getElementById('usdWithdraw').value);
      if (!usd) return alert('Enter USD amount');
      const tx = await vault.withdrawPLS(usdToPLS(usd));
      await tx.wait(); alert(`Withdrew $${usd.toFixed(2)}`); updateAll();
    };
    document.getElementById('riskBtn').onclick = async () => {
      const can = await vault.canLiquidate(account);
      document.getElementById('riskDisplay').innerHTML = can
        ? '<span class="risk">LIQUIDATION RISK – ACT NOW!</span>'
        : '<span class="safe">You are safe from liquidation</span>';
    };

    if (window.ethereum?.selectedAddress) connectWallet();
  </script>
</body>
</html>
